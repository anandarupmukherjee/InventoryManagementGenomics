{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transfer Location Stock</title>
    <link rel="stylesheet" href="{% static 'inventory/styles.css' %}">
</head>
<body>
    {% include "includes/navbar.html" %}

    <div class="dashboard-container">
        <div class="card form-card">
            <h2>Transfer Stock Between Locations</h2>

            <form method="get" class="inline-form">
                <label for="id_barcode_lookup">Scan Barcode:</label>
                <input type="text" id="id_barcode_lookup" name="barcode_lookup" placeholder="Scan code to prefill" value="{{ barcode_lookup_value|default:'' }}" autofocus>
                <button type="submit" class="btn btn-secondary">Lookup</button>
            </form>

            <form method="post">
                {% csrf_token %}
                {{ form.as_p }}
                <div class="info-text" id="stock-info">
                    Current stock:
                    <span id="current-stock-value">
                        {% if initial_stock_quantity is not None %}{{ initial_stock_quantity }}{% else %}-{% endif %}
                    </span>
                    |
                    Threshold:
                    <span id="threshold-value">
                        {% if selected_item %}{{ selected_item.product.threshold }}{% else %}-{% endif %}
                    </span>
                </div>
                <button type="submit" class="btn btn-primary">Transfer</button>
                <a href="{% url 'location_tracking:overview' %}" class="btn btn-secondary">Back</a>
            </form>

            {% if location_balances %}
              <div class="card table-card" style="margin-top:16px;">
                <h3>Current Allocation for this Lot</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Location</th>
                      <th>Quantity</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for entry in location_balances %}
                      <tr>
                        <td>{{ entry.location.name }}</td>
                        <td>{{ entry.quantity }}</td>
                      </tr>
                    {% empty %}
                      <tr><td colspan="2">No location data.</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const productItemSelect = document.getElementById("id_product_item");
            const fromLocationSelect = document.getElementById("id_from_location");
            const currentDisplay = document.getElementById("current-stock-value");
            const thresholdDisplay = document.getElementById("threshold-value");
            const infoUrl = "{% url 'location_tracking:location_stock_info' %}";

            async function updateLocationInfo() {
                const productItem = productItemSelect ? productItemSelect.value : "";
                const fromLocation = fromLocationSelect ? fromLocationSelect.value : "";

                if (!productItem || !fromLocation) {
                    currentDisplay.textContent = "-";
                    thresholdDisplay.textContent = "-";
                    return;
                }

                try {
                    const response = await fetch(`${infoUrl}?product_item=${productItem}&location=${fromLocation}`, {
                        headers: {"X-Requested-With": "XMLHttpRequest"},
                    });
                    if (!response.ok) throw new Error("Failed to fetch stock info");
                    const data = await response.json();
                    currentDisplay.textContent = data.current_stock ?? "-";
                    thresholdDisplay.textContent = data.threshold ?? "-";
                } catch (err) {
                    console.error("Failed to update location info", err);
                    currentDisplay.textContent = "-";
                    thresholdDisplay.textContent = "-";
                }
            }

            if (productItemSelect && fromLocationSelect) {
                fromLocationSelect.addEventListener("change", updateLocationInfo);
                productItemSelect.addEventListener("change", updateLocationInfo);
                updateLocationInfo();
            }
        });
    </script>
</body>
</html>
